#!/bin/bash

MUSIC_DIR="$MUSIC/library"
file="$(mpc --format %file% current)"
album_dir="${file%/*}"
cover="$MUSIC_DIR/$album_dir/cover.jpg"

config="$DOTFILES/cava/config"
num=2

colors=$(get_colors.py $num "$cover")
perl -pi -e 's/^gradient_count = \d+$/gradient_count = '$num'/' -- "$config"

if [[ -z "$colors" ]]; then
    colors='#222222
#ffffff'
fi

i=1
modified=0
for color in $(echo "$colors"); do
    if cat "$config" | grep "gradient_color_$i = '$color'"; then
        echo "NOT MODIFYING"
        ((i++))
        continue
    fi
    echo "MODIFYING"
    if cat "$config" | grep "gradient_color_$i"; then
        perl -pi -e "s/^gradient_color_$i = '#[0-9A-Fa-f]+'$/gradient_color_$i = '$color'/" "$config"
    else
        echo "gradient_color_$i = '$color'" >> $config
    fi
    modified=1
    ((i++))
done

((modified == 1)) && pkill -USR1 cava
